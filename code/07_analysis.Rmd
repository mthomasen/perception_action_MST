---
title: "07_analysis"
output: html_document
editor_options:
  chunk_output_type: console
---

```{r, include = FALSE}
library(tidyverse)
library(lme4)
library(lmerTest)
library(emmeans)
library(performance)

knitr::opts_chunk$set(message = FALSE, warning = FALSE)

figures_dir <- "/work/Perception_and_action/figures"
```

```{r}
theme_set(
  theme_minimal(base_size = 13) +
    theme(
      plot.title = element_text(face = "bold"),
      panel.grid.minor = element_blank(),
      legend.position = "right"
    )
)

pal_okabe_ito <- c(
  "low_eco"  = "#0072B2",  
  "high_eco" = "#D55E00"   
)
```

## Load data
```{r}
analysis_df <- read_csv(
  file.path("/work/Perception_and_action/data", "analysis", "analysis_df.csv"),
  show_col_types = FALSE
) %>%
  mutate(
    participant = factor(participant),
    item_id = factor(item_id),
    badge_salience = factor(badge_salience, levels = c("no_badge", "badge_low", "badge_high")),
    eco_signal = factor(eco_signal, levels = c("low_eco", "high_eco")),
    green_words = as.integer(green_words)
  )
```

## Model
```{r}
m_rating <- lmer(
  rating ~ badge_salience + eco_signal + green_words +
    (1 | participant) + (1 | item_id),
  data = analysis_df
)


summary(m_rating)

anova(m_rating)

```
#### Assumption check
```{r}
diag_df <- tibble(
  fitted = fitted(m_rating),
  resid = resid(m_rating)
)

p_resid_fitted <- ggplot(diag_df, aes(x = fitted, y = resid)) +
  geom_point(alpha = 0.4) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_smooth(method = "loess", se = FALSE) +
  labs(
    title = "Residuals vs fitted",
    x = "fitted values",
    y = "residuals"
  )

p_resid_fitted

ggsave(
  filename = "diag_residuals_vs_fitted.png",
  plot = p_resid_fitted,
  path = figures_dir,
  width = 7,
  height = 4,
  dpi = 300
)

p_qq <- ggplot(diag_df, aes(sample = resid)) +
  stat_qq() +
  stat_qq_line(color = "red", linewidth = 1) +
  labs(
    title = "Normal Q–Q plot (residuals)",
    x = "theoretical quantiles",
    y = "sample quantiles"
  )

p_qq

ggsave(
  filename = "diag_qqplot_residuals.png",
  plot = p_qq,
  path = figures_dir,
  width = 7,
  height = 4,
  dpi = 300
)

check_collinearity(m_rating)
check_normality(m_rating) 
check_heteroscedasticity(m_rating)
```

## Hypothesis testing 

```{r}
emm_badge <- emmeans(m_rating, ~ badge_salience)

#H1: badge present vs. no badge
h1 <- contrast(
  emm_badge,
  method = list("badge_present_vs_no_badge" = c(-1, 0.5, 0.5))
)
summary(h1, infer = c(TRUE, TRUE), level = 0.95)

#H2: high salience vs. low salience
h2 <- contrast(
  emm_badge,
  method = list("badge_high_vs_badge_low" = c(0, -1, 1))
)

summary(h2, infer = c(TRUE, TRUE), level = 0.95)
```


## Estimated marignal means plot
```{r}
emm_df <- as.data.frame(emmeans(m_rating, ~ badge_salience | eco_signal)) %>%
  mutate(
    badge_salience = factor(
      badge_salience,
      levels = c("no_badge", "badge_low", "badge_high"),
      labels = c("No badge", "Badge (low salience)", "Badge (high salience)")
    )
  )

emm_plot <- ggplot(
  emm_df,
  aes(
    x = badge_salience, y = emmean,
    group = eco_signal,
    linetype = eco_signal,
    color = eco_signal
  )
) +
  geom_line(linewidth = 0.9) +
  geom_point(size = 2.4) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.12) +
  scale_color_manual(values = pal_okabe_ito) +
  labs(
    title = "Estimated marginal means — Rating",
    x = "badge condition",
    y = "estimated mean rating",
    color = "eco-signal",
    linetype = "eco-signal"
  )


emm_plot

ggsave(
  filename = "emm_plot.png",
  plot = emm_plot,
  path = figures_dir,
  width = 7,
  height = 4,
  dpi = 300
)
```

## Exploratory model comparison
```{r}
m_rating_int <- lmer(
  rating ~ badge_salience * eco_signal + green_words +
    (1 | participant) + (1 | item_id),
  data = analysis_df
)

anova(m_rating, m_rating_int)
```

